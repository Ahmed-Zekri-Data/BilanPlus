<div class="list-container">
  <h2>Liste des Devis</h2>

  <input
    type="text"
    [(ngModel)]="searchTerm"
    name="search"
    placeholder="üîç Rechercher par r√©f√©rence ou client..."
    class="search-input"
  />

  <div class="filter-section">
    <label>Filtrer par statut:</label>
    <select [(ngModel)]="statusFilter">
      <option value="">Tous</option>
      <option value="Brouillon">Brouillon</option>
      <option value="Envoy√©">Envoy√©</option>
      <option value="Accept√©">Accept√©</option>
      <option value="Refus√©">Refus√©</option>
    </select>
  </div>

  <table *ngIf="filteredDevis.length > 0; else noDevis" class="devis-table">
    <thead>
      <tr>
        <th>R√©f√©rence</th>
        <th>Client</th>
        <th>Date √âmission</th>
        <th>√âch√©ance</th>
        <th>Montant TTC</th>
        <th>Statut</th>
        <th class="actions-col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let devis of filteredDevis; let i = index" [ngClass]="{'highlight': isHighlighted(devis)}">
        <td>{{ devis.reference }}</td>
        <td>{{ getClientName(devis.client) }}</td>
        <td>{{ devis.dateEmission | date:'dd/MM/yyyy' }}</td>
        <td>{{ devis.echeance | date:'dd/MM/yyyy' }}</td>
        <td>{{ devis.montantTTC | currency:'EUR' }}</td>
        <td>
          <span class="status-badge" [ngClass]="'status-' + devis.statut.toLowerCase().replace(' ', '-')">
            {{ devis.statut }}
          </span>
        </td>
        <td class="actions-col">
          <button class="btn view" (click)="viewDevis(i)">D√©tails</button>
          <button class="btn convert" *ngIf="devis.statut === 'Accept√©'" (click)="convertToFacture(i)">Convertir en Facture</button>
          <button class="btn delete" (click)="deleteDevis(i)">Supprimer</button>
        </td>
      </tr>
    </tbody>
  </table>

  <ng-template #noDevis>
    <p>Aucun devis ne correspond √† la recherche.</p>
  </ng-template>

  <div *ngIf="selectedDevis" class="modal">
    <div class="modal-content">
      <span class="close" (click)="closeModal()">&times;</span>
      <h3>D√©tails du Devis - {{ selectedDevis.reference }}</h3>
      
      <div class="devis-details">
        <div class="detail-section">
          <h4>Informations G√©n√©rales</h4>
          <p><strong>R√©f√©rence:</strong> {{ selectedDevis.reference }}</p>
          <p><strong>Client:</strong> {{ getClientName(selectedDevis.client) }}</p>
          <p><strong>Date d'√©mission:</strong> {{ selectedDevis.dateEmission | date:'dd/MM/yyyy' }}</p>
          <p><strong>Date d'√©ch√©ance:</strong> {{ selectedDevis.echeance | date:'dd/MM/yyyy' }}</p>
          <p><strong>Statut:</strong> 
            <span class="status-badge" [ngClass]="'status-' + selectedDevis.statut.toLowerCase().replace(' ', '-')">
              {{ selectedDevis.statut }}
            </span>
          </p>
        </div>
        
        <div class="detail-section">
          <h4>Produits</h4>
          <table class="products-table">
            <thead>
              <tr>
                <th>Produit</th>
                <th>Quantit√©</th>
                <th>Prix unitaire</th>
                <th>Total HT</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let produit of selectedDevisProduits">
                <td>{{ produit.nom }}</td>
                <td>{{ produit.quantite }}</td>
                <td>{{ produit.prix | currency:'EUR' }}</td>
                <td>{{ produit.prix * produit.quantite | currency:'EUR' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="detail-section totals">
          <p><strong>Total HT:</strong> {{ selectedDevis.montantHT | currency:'EUR' }}</p>
          <p><strong>TVA ({{ selectedDevis.tva }}%):</strong> {{ selectedDevis.montantTVA | currency:'EUR' }}</p>
          <p class="grand-total"><strong>Total TTC:</strong> {{ selectedDevis.montantTTC | currency:'EUR' }}</p>
        </div>

        <div class="action-buttons">
          <button *ngIf="selectedDevis.statut === 'Brouillon'" class="btn accept" (click)="changeDevisStatus('Accept√©')">Accepter</button>
          <button *ngIf="selectedDevis.statut === 'Brouillon'" class="btn refuse" (click)="changeDevisStatus('Refus√©')">Refuser</button>
          <button *ngIf="selectedDevis.statut === 'Accept√©'" class="btn convert" (click)="convertSelectedDevisToFacture()">Convertir en Facture</button>
        </div>
      </div>
    </div>
  </div>
</div>
