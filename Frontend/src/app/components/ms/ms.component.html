<div class="ms-container">
  <h2>Mouvements de Stock</h2>
  <a routerLink="/produit" class="btn btn-secondary mb-3">Retour aux Produits</a>

  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Section Alertes Stock -->
  <div *ngIf="hasLowStockItems()" class="alert alert-warning mb-3">
    <h4><i class="fas fa-exclamation-triangle"></i> Alertes Stock Bas</h4>
    <div *ngFor="let movement of stockMovements">
      <div *ngIf="isLowStock(movement)" class="mb-2 pl-3">
        <strong>{{ getProduitNom(movement.produit) }}</strong>:
        Stock actuel = <span class="text-danger">{{ getProduitStock(movement.produit) }}</span>,
        Seuil d'alerte = {{ getProduitSeuil(movement.produit) }}
        <span *ngIf="getProduitStock(movement.produit) === 0" class="badge badge-danger ml-2">RUPTURE</span>
        <span *ngIf="getProduitStock(movement.produit) > 0 && getProduitStock(movement.produit) <= getProduitSeuil(movement.produit)" 
              class="badge badge-warning ml-2">STOCK BAS</span>
      </div>
    </div>
  </div>

  <button class="btn btn-primary mb-3" (click)="showForm = true; editingMovement = null">
    <i class="fas fa-plus"></i> Ajouter un Mouvement
  </button>

  <div *ngIf="showForm" class="card mb-4">
    <div class="card-body">
      <h4 class="card-title">{{ editingMovement ? 'Modifier' : 'Ajouter' }} un Mouvement</h4>
      <form #movementForm="ngForm" (ngSubmit)="onSubmit()">
        <div class="alert alert-info" *ngIf="movementForm">
          Form valid: {{ movementForm.valid }}
        </div>
        <div class="form-group">
          <label>Produit ID:</label>
          <input
            type="text"
            class="form-control"
            [ngModel]="editingMovement ? editingMovement.produit : newMovement.produit"
            (ngModelChange)="updateField('produit', $event)"
            name="produit"
            required
          />
        </div>
        <div class="form-group">
          <label>Type:</label>
          <select
            class="form-control"
            [ngModel]="editingMovement ? editingMovement.type : newMovement.type"
            (ngModelChange)="updateField('type', $event)"
            name="type"
            required
          >
            <option value="">-- Sélectionnez --</option>
            <option value="entrée">Entrée</option>
            <option value="sortie">Sortie</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantité:</label>
          <input
            type="number"
            class="form-control"
            [ngModel]="editingMovement ? editingMovement.quantite : newMovement.quantite"
            (ngModelChange)="updateField('quantite', $event)"
            name="quantite"
            required
            min="0"
            step="1"
            placeholder="Quantité"
          />
        </div>
        <div class="form-group">
          <label>Date:</label>
          <input
            type="datetime-local"
            class="form-control"
            [ngModel]="(editingMovement ? editingMovement.date : newMovement.date) | date:'yyyy-MM-ddTHH:mm'"
            (ngModelChange)="updateDate($event)"
            name="date"
            required
          />
        </div>
        <div class="form-group" *ngIf="editingMovement && !isString(editingMovement.produit)">
          <div class="alert alert-info">
            <strong>Info Stock:</strong> 
            Actuel: {{ getProduitStock(editingMovement.produit) }} |
            Seuil: {{ getProduitSeuil(editingMovement.produit) }}
          </div>
        </div>
        <div class="form-buttons">
          <button type="submit" class="btn btn-success mr-2" [disabled]="!movementForm.valid">
            <i class="fas fa-save"></i> {{ editingMovement ? 'Mettre à jour' : 'Ajouter' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="editingMovement ? cancelEdit() : resetForm()">
            <i class="fas fa-times"></i> Annuler
          </button>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="stockMovements.length > 0" class="alert alert-info">
    Nombre de mouvements: {{ stockMovements.length }}
    <!-- Removed Debug: <pre>Debug: {{ stockMovements | json }}</pre> -->
  </div>
  <table class="table table-striped table-hover" *ngIf="stockMovements.length > 0">
    <thead class="thead-dark">
      <tr>
        <th>ID</th>
        <th>Produit</th>
        <th>Type</th>
        <th>Quantité</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let movement of stockMovements" [class.table-warning]="isLowStock(movement)">
        <td>{{ movement._id }}</td>
        <td>
          {{ getProduitNom(movement.produit) }}
          <span *ngIf="isLowStock(movement)" class="badge badge-warning ml-2">
            <i class="fas fa-exclamation-circle"></i> Alerte
          </span>
        </td>
        <td>
          <span [class.text-success]="movement.type === 'entrée'" 
                [class.text-danger]="movement.type === 'sortie'">
            {{ movement.type | uppercase }}
          </span>
        </td>
        <td>{{ movement.quantite }}</td>
        <td>{{ movement.date | date:'medium' }}</td>
        <td>
          <button class="btn btn-sm btn-warning mr-2" (click)="editMovement(movement)" title="Modifier">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" (click)="deleteMovement(movement._id || '')" title="Supprimer">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="stockMovements.length === 0 && !errorMessage" class="alert alert-info">
    <i class="fas fa-info-circle"></i> Aucun mouvement de stock trouvé.
  </div>
</div>