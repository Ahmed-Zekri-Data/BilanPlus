<div *ngIf="isEditMode && !tva._id && isLoading ? loading : true">
  <h2>{{ isEditMode ? 'Modifier TVA' : 'Ajouter une nouvelle TVA' }}</h2>

  <form (ngSubmit)="saveTVA()">
    <div class="form-group">
      <label for="taux">Taux (%):</label>
      <select
        id="taux"
        name="taux"
        [(ngModel)]="tva.taux"
        (ngModelChange)="onTauxChange($event)"
        required
      >
        <option [ngValue]="7">7%</option>
        <option [ngValue]="13">13%</option>
        <option [ngValue]="19">19%</option>
      </select>
      <p *ngIf="fieldErrors.taux" class="error">{{ fieldErrors.taux }}</p>
    </div>

    <div class="form-group">
      <label for="montant">Montant (DT):</label>
      <input
        type="number"
        id="montant"
        name="montant"
        [(ngModel)]="tva.montant"
        min="0"
        step="0.01"
        required
        [readonly]="tva.declarations && tva.declarations.length > 0"
        [title]="tva.declarations && tva.declarations.length > 0 ? 'Le montant est calculé automatiquement à partir des déclarations sélectionnées' : ''"
      >
      <p *ngIf="tva.declarations && tva.declarations.length > 0" class="info">
        Le montant est calculé automatiquement à partir des déclarations sélectionnées
      </p>
      <p *ngIf="fieldErrors.montant" class="error">{{ fieldErrors.montant }}</p>
    </div>

    <div class="form-group">
      <label for="declarations">Déclarations Fiscales (optionnel):</label>
      <p class="info-text">
        Vous pouvez associer cette TVA à une ou plusieurs déclarations fiscales. Le montant de TVA sera automatiquement calculé comme la somme des TVA dues des déclarations sélectionnées.
      </p>
      <select
        id="declarations"
        name="declarations"
        [(ngModel)]="tva.declarations"
        (ngModelChange)="onDeclarationsChange()"
        multiple
      >
        <option *ngFor="let decl of declarations" [ngValue]="decl._id">
          {{ decl.periode }} (Montant: {{ decl.montantTotal | number:'1.2-2' }} TND)
        </option>
      </select>
      <p *ngIf="fieldErrors.declarations" class="error">{{ fieldErrors.declarations }}</p>
    </div>

    <div class="actions">
      <button mat-raised-button color="primary" type="submit">
        {{ isEditMode ? 'Mettre à jour TVA' : 'Ajouter TVA' }}
      </button>
      <button mat-raised-button (click)="goBack()">Annuler</button>
    </div>

    <div *ngIf="errors.length > 0 && !fieldErrors.taux && !fieldErrors.montant && !fieldErrors.declarations" class="error-container">
      <p class="error-title">Erreur(s) :</p>
      <ul>
        <li *ngFor="let error of errors" class="error">{{ error }}</li>
      </ul>
    </div>
  </form>
</div>

<ng-template #loading>
  <div *ngIf="errors.length > 0; else spinner" class="error-container">
    <p class="error-title">Erreur(s) :</p>
    <ul>
      <li *ngFor="let error of errors" class="error">{{ error }}</li>
    </ul>
  </div>
  <ng-template #spinner>
    <p>Chargement des détails de la TVA...</p>
  </ng-template>
</ng-template>